name: Multi-Stage Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Concurrency pour Ã©viter les dÃ©ploiements parallÃ¨les
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------
  # JOB 1: CODE QUALITY
  # --------------------------------------------
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
      continue-on-error: false
    
    - name: Run security audit
      run: npm audit --audit-level=moderate
    
    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: lint-results
        path: |
          eslint-results.json
          npm-audit-results.json
        retention-days: 7

  # --------------------------------------------
  # JOB 2: TESTS UNITAIRES ET COVERAGE
  # --------------------------------------------
  tests:
    name: ğŸ§ª Tests & Coverage
    runs-on: ubuntu-latest
    needs: code-quality  # DÃ©pend du job prÃ©cÃ©dent
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm run test:coverage
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: junit.xml
        retention-days: 30

  # --------------------------------------------
  # JOB 3: BUILD ET PACKAGING
  # --------------------------------------------
  build:
    name: ğŸ“¦ Build & Package
    runs-on: ubuntu-latest
    needs: tests  # DÃ©pend des tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Create package
      run: npm run package
    
    - name: Generate version info
      run: |
        echo "{\"version\":\"1.0.0\",\"commit\":\"${{ github.sha }}\",\"timestamp\":\"$(date -Iseconds)\"}" > version.json
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: application-build
        path: |
          dist/
          app.tar.gz
          version.json
        retention-days: 90

  # --------------------------------------------
  # JOB 4: DÃ‰PLOIEMENT DEVELOPMENT (AUTOMATIQUE)
  # --------------------------------------------
  deploy-development:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    environment:
      name: development
      url: https://dev.example.com
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: application-build
        path: ./download
    
    - name: List downloaded files
      run: ls -la ./download
    
    - name: Deploy to development
      env:
        API_KEY: ${{ secrets.DEV_API_KEY }}
      run: |
        echo "ğŸš€ Deploying to development environment..."
        echo "Using API Key: $API_KEY"
        echo "Commit: ${{ github.sha }}"
        echo "âœ… Deployment to development complete"
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests on development..."
        sleep 5
        echo "âœ… Smoke tests passed"

  # --------------------------------------------
  # JOB 5: DÃ‰PLOIEMENT STAGING (AVEC REVIEWERS OPTIONNELS)
  # --------------------------------------------
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: application-build
        path: ./download
    
    - name: Deploy to staging
      env:
        API_KEY: ${{ secrets.STAGING_API_KEY }}
        DB_URL: ${{ secrets.STAGING_DB_URL }}
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "Using API Key: $API_KEY"
        echo "Database: $DB_URL"
        echo "âœ… Deployment to staging complete"
    
    - name: Run integration tests
      run: |
        echo "Running integration tests on staging..."
        sleep 10
        echo "âœ… Integration tests passed"
    
    - name: Generate deployment report
      run: |
        echo "## Staging Deployment Report" > deployment-report.md
        echo "- **Commit**: ${{ github.sha }}" >> deployment-report.md
        echo "- **Timestamp**: $(date)" >> deployment-report.md
        echo "- **Status**: Success" >> deployment-report.md
    
    - name: Upload deployment report
      uses: actions/upload-artifact@v3
      with:
        name: staging-deployment-report
        path: deployment-report.md
        retention-days: 30

  # --------------------------------------------
  # JOB 6: DÃ‰PLOIEMENT PRODUCTION (APPROBATION REQUISE)
  # --------------------------------------------
  deploy-production:
    name: ğŸ”’ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    
    environment:
      name: production
      url: https://prod.example.com
    
    # Protection rules configurÃ©es dans l'environnement GitHub
    # - Required reviewers (2 personnes)
    # - Wait timer (5 minutes)
    # - Branches restreintes (main uniquement)
    
    steps:
    - name: Wait for manual approval
      uses: actions/github-script@v6
      with:
        script: |
          console.log('â³ Waiting for manual approval in GitHub UI...');
          console.log('This job is protected by environment rules:');
          console.log('- Required reviewers');
          console.log('- 5 minute wait timer');
          console.log('- Deployment branch: main');
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: application-build
        path: ./download
    
    - name: Deploy to production
      env:
        API_KEY: ${{ secrets.PROD_API_KEY }}
        DB_URL: ${{ secrets.PROD_DB_URL }}
      run: |
        echo "ğŸ”¥ Deploying to PRODUCTION..."
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "Version: 1.0.0"
        echo "Commit: ${{ github.sha }}"
        echo "âœ… Production deployment complete"
    
    - name: Verify deployment
      run: |
        echo "Running post-deployment verification..."
        sleep 15
        echo "âœ… All health checks passed"
    
    - name: Notify team
      if: success()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "ğŸ“¢ Sending notification to Slack..."
        echo "Production deployment successful!"
        echo "Deployed by: ${{ github.actor }}"
        echo "Commit: ${{ github.sha }}"

  # --------------------------------------------
  # JOB 7: RAPPORT DE SYNTHÃˆSE
  # --------------------------------------------
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-quality, tests, build, deploy-development, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: Generate pipeline summary
      run: |
        echo "## ğŸ“‹ Multi-Stage Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“¦ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ Development | ${{ needs.deploy-development.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”’ Production | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Final status
      run: |
        if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
          echo "ğŸ‰ All stages completed successfully!"
        else
          echo "âš ï¸ Pipeline completed with issues"
        fi